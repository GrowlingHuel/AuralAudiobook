# Acoustic Alchemy: Technical Post-Mortem & Implementation Report

**Date:** December 26, 2025
**System:** Android 15 (Linux)
**Model:** Kokoro-82M (v1.0) ONNX

## 1. The "Phoneme Alignment" Crisis

### The Issue
Initial inference attempts resulted in audio that sounded like "Foreign Language" or "Slavic" gibberish, despite the input text being English. This was identified as a **vocab mismatch** between our tokenizer's output and the model's internal expectations.

### Root Cause Analysis
- The model (Kokoro v1.0) was trained using a specific **IPA (International Phonetic Alphabet)** vocabulary via `espeak-ng`, not a standard BERT or ASCII token set.
- Using a generic tokenizer resulted in IDs that pointed to incorrect phonemes in the model's embedding matrix.
- **Example**: Generating ID `163` (out of bounds or mapped to a different symbol) instead of the correct IPA index.

### The Solution: 2tokenizer.json Compliance
We aligned the input IDs to the strict `2tokenizer.json` IPA vocabulary derived from the model's training data.

**Key Alignment (Call me Ishmael):**
- **Call** (/kɔːl/): `53 (k)`, `76 (ɔ)`, `158 (ː)`, `54 (l)`
- **Me** (/mi/): `55 (m)`, `51 (i)`
- **Ishmael** (/ˈɪʃmeɪl/): `156 (ˈ)`, `102 (ɪ)`, `131 (ʃ)`, `55 (m)`, `47 (e)`, `51 (i)`, `54 (l)`
- **Separators**: Space (`16`), Start/End (`0`)

**Final Sequence used for Verification:**
`[0, 53, 76, 158, 54, 16, 55, 51, 16, 156, 102, 131, 55, 47, 51, 54, 0]`

This precise mapping eliminated the foreign accent, producing clear American English.

## 2. Audio Pipeline Specifications

To ensure high-fidelity playback without pitch shifting ("chipmunk effect") or jitter, the audio pipeline was strictly configured:

- **Sample Rate**: **24,000 Hz** (Native model output).
- **Channel Config**: **Mono** (`AudioFormat.CHANNEL_OUT_MONO`).
- **Format**: **16-bit PCM** (`AudioFormat.ENCODING_PCM_16BIT`).
- **Float-to-PCM Conversion**: The ONNX model outputs Float32 values in the range `[-1.0, 1.0]`. These are scaled by `32767` to fit the `Short` (Int16) range.
- **Buffer Strategy**: `AudioTrack.getMinBufferSize(...) * 2`. Doubling the minimum buffer size prevents underrun/jitter on emulators, which was contributing to the perception of "slurring".

## 3. Android 15 & Build Compatibility

### 16KB Page Alignment
Android 15 enforces 16KB native library alignment. The build failed initially due to unaligned native libs from `onnxruntime-android`.
**Fix**: Added `android.packagingOptions.jniLibs.useLegacyPackaging = true` in `build.gradle.kts`.

### JVM Heap Space
The standard Gradle daemon ran out of memory ("Expiring Daemon") during the resource-heavy ONNX build process.
**Fix**: Increased heap size in `gradle.properties`:
```properties
org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g
```

## 4. The Nebula UI (Voice Blending)

The **Nebula Voice Lab** provides a visual interface for the Multi-Speaker Style Vector (Shape: `[1, 256]`).

### Implementation Details
- **Framework**: Jetpack Compose.
- **Coordinate System**: A 2D Logical Plane `[-1.0, 1.0]`.
- **Voices**:
    - **Adam**: `(0.5, 0.8)` (Deep/Neutral)
    - **Bella**: `(-0.7, -0.4)` (Soft/High)
    - **Sky**: `(0.7, -0.3)` (Expressive)
- **Mathematical Blending**:
    - Inverse Distance Weighting (IDW) is used to calculate weights based on the user's draggable "Probe".
    - `Style = (WeightA * VectorA) + (WeightB * VectorB) + ...`
- **Visual Feedback**: The central Probe pulses (animates its Alpha/Glow) synchronized with the `isSpeaking` state, providing immediate visual confirmation of audio generation.

---
*Generated by Antigravity Agent*
